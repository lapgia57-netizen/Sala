<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sala • Cyber Netizen Lounge</title>
  <link rel="icon" href="https://raw.githubusercontent.com/lapgia57-netizen/gohome/main/favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  
  <style>
    :root {
      --bg: #0d1117;
      --surface: #161b22;
      --text: #c9d1d9;
      --accent: #00ffea;
      --accent-dark: #00b3a2;
      --danger: #f85149;
      --glass: rgba(22, 27, 34, 0.7);
      --border: #30363d;
      --overlay: rgba(0,0,0,0.75);
    }

    [data-theme="light"] {
      --bg: #f6f8fa;
      --surface: #ffffff;
      --text: #24292f;
      --accent: #0969da;
      --accent-dark: #0550ae;
      --danger: #cf222e;
      --glass: rgba(255,255,255,0.92);
      --border: #d0d7de;
      --overlay: rgba(0,0,0,0.65);
    }

    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* ── Loading Overlay ── */
    #global-loader {
      position: fixed;
      inset: 0;
      background: var(--bg);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      opacity: 1;
      transition: opacity 0.6s ease, visibility 0.6s ease;
      visibility: visible;
    }

    #global-loader.hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }

    .loader {
      width: 80px;
      height: 80px;
      border: 5px solid var(--surface);
      border-top: 5px solid var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 1.5rem;
    }

    .loader-text {
      font-size: 1.2rem;
      color: var(--accent);
      text-shadow: 0 0 10px var(--accent);
      letter-spacing: 1.5px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ── Header & Sidebar (giữ nguyên phần lớn) ── */
    .header {
      background: linear-gradient(135deg, #010409, #0a0e14);
      padding: 0.9rem 1.2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 3px solid var(--danger);
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    h1 {
      font-size: clamp(1.7rem, 5.5vw, 2.2rem);
      color: var(--accent);
      text-shadow: 0 0 12px var(--accent);
    }

    .status-bar { font-size: 0.78rem; color: #8b949e; margin-top: 4px; }

    .controls { display: flex; align-items: center; gap: 1.1rem; }

    .theme-toggle, .menu-toggle {
      background: none;
      border: none;
      color: var(--text);
      font-size: 1.6rem;
      cursor: pointer;
      transition: all 0.25s;
    }

    .theme-toggle:hover, .menu-toggle:hover { 
      transform: rotate(20deg) scale(1.12); 
    }

    .sidebar {
      position: fixed;
      inset: 0;
      width: 320px;
      max-width: 85vw;
      background: var(--surface);
      border-right: 1px solid var(--border);
      transform: translateX(-100%);
      transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      z-index: 900;
      display: flex;
      flex-direction: column;
    }

    .sidebar.open { transform: translateX(0); }

    @media (min-width: 901px) {
      .sidebar {
        position: relative;
        transform: translateX(0);
        width: 340px;
        height: calc(100vh - 76px);
      }
      .menu-toggle { display: none; }
    }

    .search-container {
      padding: 1rem;
      background: var(--bg);
      border-bottom: 1px solid var(--border);
    }

    .search {
      width: 100%;
      padding: 11px 14px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 0.96rem;
    }

    .tree-container {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem 0.3rem;
    }

    .tree ul { list-style: none; padding-left: 1.3rem; margin: 3px 0; }
    .tree li {
      padding: 9px 14px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.18s;
      display: flex;
      align-items: center;
      gap: 9px;
      font-size: 0.96rem;
    }

    .tree li:hover { background: rgba(48,54,61,0.45); }
    .tree li.active { background: rgba(0,255,234,0.22); color: var(--accent); }

    .folder::before { content: "\f07b"; font-family: "Font Awesome 6 Free"; font-weight: 900; color: #e2c14c; }
    .file::before { content: "\f15b"; font-family: "Font Awesome 6 Free"; color: #6ca0f6; }

    .online-badge {
      background: #238636;
      color: white;
      font-size: 0.68rem;
      padding: 2px 8px;
      border-radius: 10px;
      margin-left: auto;
    }

    .content {
      flex: 1;
      padding: clamp(1rem, 4vw, 1.6rem);
      padding-top: clamp(82px, 13vw, 94px);
      background: linear-gradient(to bottom, var(--bg), #0a0e14);
    }

    #preview-pane {
      background: var(--glass);
      backdrop-filter: blur(12px);
      border: 1px solid var(--border);
      border-radius: 14px;
      height: calc(100vh - 110px);
      min-height: 65vh;
      overflow: hidden;
      box-shadow: 0 10px 40px rgba(0,0,0,0.45);
      position: relative;
    }

    .bottom-bar {
      position: fixed;
      bottom: 18px;
      right: 18px;
      background: rgba(35,134,54,0.92);
      backdrop-filter: blur(10px);
      color: white;
      padding: 10px 18px;
      border-radius: 50px;
      font-weight: 600;
      font-size: 0.92rem;
      box-shadow: 0 5px 25px rgba(0,0,0,0.55);
      z-index: 700;
      transition: transform 0.25s;
    }

    .bottom-bar:hover { transform: scale(1.08); }
  </style>
</head>
<body data-theme="dark">

  <!-- Loading toàn màn hình khi mở trang mới -->
  <div id="global-loader">
    <div class="loader"></div>
    <div class="loader-text">ĐANG MỞ CỬA VŨ TRỤ...</div>
  </div>

  <div class="header">
    <div>
      <h1>SALA <span style="font-size:0.56em; opacity:0.72;">CYBER LOUNGE</span></h1>
      <div class="status-bar">
        Đang có <span id="online">0</span> netizen đang chill • Auto sync mỗi 2 phút
      </div>
    </div>

    <div class="controls">
      <button class="theme-toggle" title="Chuyển theme" onclick="toggleTheme()">
        <i class="fas fa-moon"></i>
      </button>
      <button class="menu-toggle" aria-label="Mở menu" id="menuToggle">
        <i class="fas fa-bars"></i>
      </button>
    </div>
  </div>

  <div class="sidebar" id="sidebar">
    <div class="search-container">
      <input type="text" class="search" id="search" placeholder="Tìm nick, file, status..."/>
    </div>
    <div class="tree-container">
      <div class="tree" id="tree">
        <div class="loading-skeleton" style="padding:1.5rem;">
          <div class="skeleton-item"></div>
          <div class="skeleton-item" style="width:82%"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="content">
    <div id="preview-pane">
      <div style="height:100%;display:flex;align-items:center;justify-content:center;color:var(--accent);font-size:1.3rem;opacity:0.7;">
        Chọn một file để mở trong tab mới ✨
      </div>
    </div>
  </div>

  <div class="bottom-bar">
    Online: <span id="online2">0</span> netizen
  </div>

  <script>
    const owner = "lapgia57-netizen";
    const repo = "Sala";
    const api = `https://api.github.com/repos/${owner}/${repo}/git/trees/main?recursive=1`;
    const customDomain = "https://portfolio.lck.io.vn/";

    let currentActiveLi = null;

    // Loading overlay
    function showLoader() {
      document.getElementById("global-loader").classList.remove("hidden");
    }

    function hideLoader() {
      setTimeout(() => {
        document.getElementById("global-loader").classList.add("hidden");
      }, 600);
    }

    // Mobile menu
    const menuToggle = document.getElementById("menuToggle");
    const sidebar = document.getElementById("sidebar");
    const overlay = document.createElement("div");
    overlay.className = "overlay";
    document.body.appendChild(overlay);

    function toggleMenu() {
      const isOpen = sidebar.classList.toggle("open");
      overlay.classList.toggle("active", isOpen);
      menuToggle.querySelector("i").className = isOpen ? "fas fa-times" : "fas fa-bars";
    }

    menuToggle.addEventListener("click", toggleMenu);
    overlay.addEventListener("click", toggleMenu);

    // Theme toggle
    function toggleTheme() {
      const body = document.body;
      const current = body.getAttribute("data-theme");
      const next = current === "light" ? "dark" : "light";
      body.setAttribute("data-theme", next);
      document.querySelector(".theme-toggle i").className = 
        next === "light" ? "fas fa-sun" : "fas fa-moon";
    }

    async function loadRepo(silent = false) {
      try {
        const res = await fetch(api);
        if (!res.ok) throw new Error("Repo not public or rate limit");
        const data = await res.json();

        const onlineFiles = data.tree.filter(f => f.type === "blob" && f.path.startsWith("online/"));
        const count = onlineFiles.length;

        const onlineEl = document.getElementById("online");
        const onlineEl2 = document.getElementById("online2");

        if (!silent) {
          animateCount(onlineEl, parseInt(onlineEl.textContent) || 0, count, 1400);
          animateCount(onlineEl2, parseInt(onlineEl2.textContent) || 0, count, 1400);
        } else {
          onlineEl.textContent = count;
          onlineEl2.textContent = count;
        }

        renderTree(data.tree);
      } catch (e) {
        document.getElementById("tree").innerHTML = 
          `<p style="color:#f85149;padding:1.5rem;text-align:center">Không connect được GitHub API<br><small>${e.message}</small></p>`;
      }
    }

    function animateCount(el, start, end, duration) {
      let startTime = null;
      function step(timestamp) {
        if (!startTime) startTime = timestamp;
        const progress = Math.min((timestamp - startTime) / duration, 1);
        el.textContent = Math.floor(progress * (end - start) + start);
        if (progress < 1) requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    }

    function renderTree(items) {
      const container = document.getElementById("tree");
      container.innerHTML = "";

      const rootUl = document.createElement("ul");
      const folders = {};

      const blobs = items.filter(item => item.type === "blob");

      blobs.forEach(item => {
        const parts = item.path.split('/');
        let currentUl = rootUl;

        for (let i = 0; i < parts.length - 1; i++) {
          const folderPath = parts.slice(0, i + 1).join('/');
          if (!folders[folderPath]) {
            const li = document.createElement("li");
            li.className = "folder";
            li.innerHTML = `<span>${parts[i]}/</span>`;
            const ul = document.createElement("ul");
            ul.style.display = "none";
            li.appendChild(ul);

            li.onclick = e => {
              e.stopPropagation();
              ul.style.display = ul.style.display === "none" ? "block" : "none";
            };

            folders[folderPath] = { li, ul };

            if (i === 0) rootUl.appendChild(li);
            else folders[parts.slice(0,i).join('/')].ul.appendChild(li);
          }
          currentUl = folders[folderPath].ul;
        }

        const fileLi = document.createElement("li");
        fileLi.className = "file";
        fileLi.innerHTML = `<span>${parts[parts.length-1]}</span>`;
        
        if (item.path.startsWith("online/")) {
          const badge = document.createElement("span");
          badge.className = "online-badge";
          badge.textContent = "ONLINE";
          fileLi.appendChild(badge);
        }

        fileLi.onclick = () => {
          highlightActive(fileLi);
          openNewPage(item.path);
        };

        currentUl.appendChild(fileLi);
      });

      container.appendChild(rootUl);
    }

    function highlightActive(li) {
      document.querySelectorAll('.tree li.active').forEach(el => el.classList.remove('active'));
      li.classList.add('active');
    }

    function openNewPage(path) {
      const fullUrl = `${customDomain}${path}`;
      
      // Hiển thị loading
      showLoader();
      
      // Mở tab mới
      const newWindow = window.open(fullUrl, '_blank');
      
      // Nếu bị chặn popup → fallback mở trong cùng tab sau 2.5s
      if (!newWindow || newWindow.closed || typeof newWindow.closed == 'undefined') {
        setTimeout(() => {
          window.location.href = fullUrl;
        }, 2500);
      } else {
        // Ẩn loading sau khoảng 1.5s (cho cảm giác mượt)
        setTimeout(hideLoader, 1500);
      }
    }

    // Search
    document.getElementById("search").addEventListener("input", e => {
      const term = e.target.value.toLowerCase().trim();
      document.querySelectorAll(".tree li").forEach(li => {
        const text = li.textContent.toLowerCase();
        li.style.display = text.includes(term) || term === "" ? "" : "none";
      });
    });

    // Khởi tạo
    window.addEventListener("load", () => {
      hideLoader(); // ẩn loading ban đầu
    });

    loadRepo();
    setInterval(() => loadRepo(true), 120000);
  </script>
</body>
</html>
