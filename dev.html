<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sala • Cyber Netizen Lounge</title>
  <link rel="icon" href="https://raw.githubusercontent.com/lapgia57-netizen/gohome/main/favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  
  <style>
    :root {
      --bg: #0d1117;
      --surface: #161b22;
      --text: #c9d1d9;
      --accent: #00ffea;
      --accent-dark: #00b3a2;
      --danger: #f85149;
      --glass: rgba(22, 27, 34, 0.7);
      --border: #30363d;
      --overlay: rgba(0,0,0,0.75);
    }

    [data-theme="light"] {
      --bg: #f6f8fa;
      --surface: #ffffff;
      --text: #24292f;
      --accent: #0969da;
      --accent-dark: #0550ae;
      --danger: #cf222e;
      --glass: rgba(255,255,255,0.92);
      --border: #d0d7de;
      --overlay: rgba(0,0,0,0.65);
    }

    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    #global-loader {
      position: fixed;
      inset: 0;
      background: var(--bg);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      opacity: 1;
      transition: opacity 0.6s ease, visibility 0.6s ease;
      visibility: visible;
    }

    #global-loader.hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }

    .loader {
      width: 80px;
      height: 80px;
      border: 5px solid var(--surface);
      border-top: 5px solid var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 1.5rem;
    }

    .loader-text {
      font-size: 1.2rem;
      color: var(--accent);
      text-shadow: 0 0 10px var(--accent);
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .header {
      background: linear-gradient(135deg, #010409, #0a0e14);
      padding: 0.9rem 1.2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 3px solid var(--danger);
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    h1 {
      font-size: clamp(1.7rem, 5.5vw, 2.2rem);
      color: var(--accent);
      text-shadow: 0 0 12px var(--accent);
    }

    .status-bar { font-size: 0.78rem; color: #8b949e; margin-top: 4px; }

    .controls { display: flex; align-items: center; gap: 1.1rem; }

    .theme-toggle, .menu-toggle {
      background: none;
      border: none;
      color: var(--text);
      font-size: 1.6rem;
      cursor: pointer;
      transition: all 0.25s;
    }

    .theme-toggle:hover, .menu-toggle:hover { 
      transform: rotate(20deg) scale(1.12); 
    }

    .sidebar {
      position: fixed;
      inset: 0  auto 0 0;
      width: 320px;
      max-width: 85vw;
      background: var(--surface);
      border-right: 1px solid var(--border);
      transform: translateX(-100%);
      transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      z-index: 900;
      display: flex;
      flex-direction: column;
    }

    .sidebar.open { transform: translateX(0); }

    @media (min-width: 901px) {
      .sidebar {
        position: relative;
        transform: translateX(0);
        width: 340px;
        height: calc(100vh - 76px);
      }
      .menu-toggle { display: none; }
    }

    .search-container {
      padding: 1rem;
      background: var(--bg);
      border-bottom: 1px solid var(--border);
    }

    .search {
      width: 100%;
      padding: 11px 14px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 0.96rem;
    }

    .tree-container {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem 0.3rem;
    }

    .tree ul { list-style: none; padding-left: 1.3rem; margin: 3px 0; }
    .tree li {
      padding: 9px 14px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.18s;
      display: flex;
      align-items: center;
      gap: 9px;
      font-size: 0.96rem;
    }

    .tree li:hover { background: rgba(48,54,61,0.45); }
    .tree li.active { background: rgba(0,255,234,0.22); color: var(--accent); }

    .folder::before { content: "\f07b"; font-family: "Font Awesome 6 Free"; font-weight: 900; color: #e2c14c; }
    .file::before { content: "\f15b"; font-family: "Font Awesome 6 Free"; color: #6ca0f6; }

    .online-badge {
      background: #238636;
      color: white;
      font-size: 0.68rem;
      padding: 2px 8px;
      border-radius: 10px;
      margin-left: auto;
    }

    .content {
      flex: 1;
      padding: clamp(1rem, 4vw, 1.6rem);
      padding-top: clamp(82px, 13vw, 94px);
      background: linear-gradient(to bottom, var(--bg), #0a0e14);
      display: flex;
      flex-direction: column;
    }

    .titles-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 0.8rem;
      border-bottom: 1px solid var(--border);
    }

    .titles-header h2 {
      color: var(--accent);
      font-size: 1.5rem;
      text-shadow: 0 0 8px var(--accent);
    }

    .titles-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1.2rem;
      flex: 1;
    }

    .title-card {
      background: var(--glass);
      backdrop-filter: blur(12px);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.3rem;
      cursor: pointer;
      transition: all 0.28s ease;
      box-shadow: 0 4px 20px rgba(0,0,0,0.35);
      position: relative;
      overflow: hidden;
    }

    .title-card:hover {
      transform: translateY(-6px);
      box-shadow: 0 12px 35px rgba(0,255,234,0.18);
      border-color: var(--accent);
    }

    .title-card::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, transparent, rgba(0,255,234,0.08));
      opacity: 0;
      transition: opacity 0.4s;
    }

    .title-card:hover::before { opacity: 1; }

    .title-text {
      font-size: 1.12rem;
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 0.6rem;
    }

    .file-path {
      font-size: 0.86rem;
      color: #8b949e;
      word-break: break-all;
      opacity: 0.85;
    }

    .loading-titles, .error-titles {
      grid-column: 1 / -1;
      text-align: center;
      padding: 3rem 1rem;
      color: var(--accent);
      font-size: 1.1rem;
    }

    .error-titles { color: var(--danger); }

    .bottom-bar {
      position: fixed;
      bottom: 18px;
      right: 18px;
      background: rgba(35,134,54,0.92);
      backdrop-filter: blur(10px);
      color: white;
      padding: 10px 18px;
      border-radius: 50px;
      font-weight: 600;
      font-size: 0.92rem;
      box-shadow: 0 5px 25px rgba(0,0,0,0.55);
      z-index: 700;
      transition: transform 0.25s;
    }

    .bottom-bar:hover { transform: scale(1.08); }

    .overlay {
      position: fixed;
      inset: 0;
      background: var(--overlay);
      opacity: 0;
      visibility: hidden;
      transition: all 0.4s;
      z-index: 800;
    }

    .overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .skeleton {
      background: linear-gradient(90deg, var(--surface) 25%, #2a2f36 50%, var(--surface) 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
      border-radius: 6px;
    }

    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
  </style>
</head>
<body data-theme="dark">

  <div id="global-loader">
    <div class="loader"></div>
    <div class="loader-text">ĐANG MỞ CỬA VŨ TRỤ...</div>
  </div>

  <div class="header">
    <div>
      <h1>SALA <span style="font-size:0.56em; opacity:0.72;">CYBER LOUNGE</span></h1>
      <div class="status-bar">
        Đang có <span id="online">0</span> netizen • Auto sync mỗi 2 phút
      </div>
    </div>

    <div class="controls">
      <button class="theme-toggle" title="Chuyển theme" onclick="toggleTheme()">
        <i class="fas fa-moon"></i>
      </button>
      <button class="menu-toggle" aria-label="Mở menu" id="menuToggle">
        <i class="fas fa-bars"></i>
      </button>
    </div>
  </div>

  <div class="sidebar" id="sidebar">
    <div class="search-container">
      <input type="text" class="search" id="search" placeholder="Tìm nick, file, title..."/>
    </div>
    <div class="tree-container">
      <div class="tree" id="tree"></div>
    </div>
  </div>

  <div class="overlay" id="overlay"></div>

  <div class="content">
    <div class="titles-header">
      <h2><i class="fas fa-globe" style="margin-right:0.6rem;"></i>Netizen Pages</h2>
      <span style="font-size:0.9rem; color:#8b949e;">Tự động tải titles</span>
    </div>
    <div class="titles-grid" id="titles-grid">
      <div class="loading-titles">
        <i class="fas fa-spinner fa-spin" style="margin-right:0.6rem;"></i>Đang quét vũ trụ...
      </div>
    </div>
  </div>

  <div class="bottom-bar">
    Online: <span id="online2">0</span> netizen
  </div>

  <script>
    const owner = "lapgia57-netizen";
    const repo = "Sala";
    const treeApi = `https://api.github.com/repos/${owner}/${repo}/git/trees/main?recursive=1`;
    const rawBase = `https://raw.githubusercontent.com/${owner}/${repo}/main/`;
    const customDomain = "https://portfolio.lck.io.vn/";

    let titlesData = [];

    function showLoader() { document.getElementById("global-loader").classList.remove("hidden"); }
    function hideLoader() {
      setTimeout(() => document.getElementById("global-loader").classList.add("hidden"), 600);
    }

    // Mobile menu
    const menuToggle = document.getElementById("menuToggle");
    const sidebar = document.getElementById("sidebar");
    const overlay = document.getElementById("overlay");

    function toggleMenu() {
      const isOpen = sidebar.classList.toggle("open");
      overlay.classList.toggle("active", isOpen);
      menuToggle.querySelector("i").className = isOpen ? "fas fa-times" : "fas fa-bars";
    }

    menuToggle.addEventListener("click", toggleMenu);
    overlay.addEventListener("click", toggleMenu);

    // Theme
    function toggleTheme() {
      const body = document.body;
      const cur = body.getAttribute("data-theme") || "dark";
      const next = cur === "light" ? "dark" : "light";
      body.setAttribute("data-theme", next);
      document.querySelector(".theme-toggle i").className = next === "light" ? "fas fa-sun" : "fas fa-moon";
    }

    async function loadRepo(silent = false) {
      try {
        const res = await fetch(treeApi);
        if (!res.ok) throw new Error(res.status === 403 ? "Rate limit GitHub (60 req/h unauth)" : "Repo lỗi hoặc private");
        const { tree } = await res.json();

        // Lọc file HTML, ẩn file đặc biệt
        const htmlFiles = tree.filter(f => 
          f.type === "blob" &&
          f.path.endsWith(".html") &&
          !["CNAME", "LICENSE", "README.md", "SECURITY.md"].includes(f.path) &&
          !f.path.startsWith(".") &&
          !f.path.includes("/.")  // ẩn hidden trong subfolder
        );

        const count = htmlFiles.length;
        const onlineEl = document.getElementById("online");
        const onlineEl2 = document.getElementById("online2");

        if (!silent) {
          animateCount(onlineEl, +onlineEl.textContent || 0, count, 1400);
          animateCount(onlineEl2, +onlineEl2.textContent || 0, count, 1400);
        } else {
          onlineEl.textContent = onlineEl2.textContent = count;
        }

        renderTree(tree);
        if (!silent) await loadAllTitles(htmlFiles);
      } catch (e) {
        document.getElementById("tree").innerHTML = `<p style="color:var(--danger);padding:2rem;text-align:center">Lỗi kết nối GitHub<br><small>${e.message}</small></p>`;
        document.getElementById("titles-grid").innerHTML = `<div class="error-titles">Không tải được danh sách: ${e.message}</div>`;
      }
    }

    function animateCount(el, from, to, dur) {
      let start;
      const step = ts => {
        if (!start) start = ts;
        const prog = Math.min((ts - start) / dur, 1);
        el.textContent = Math.floor(prog * (to - from) + from);
        if (prog < 1) requestAnimationFrame(step);
      };
      requestAnimationFrame(step);
    }

    function renderTree(items) {
      const container = document.getElementById("tree");
      container.innerHTML = "";

      const root = document.createElement("ul");
      const folders = {};

      items.filter(f => f.type === "blob").forEach(item => {
        const parts = item.path.split('/');
        let curUl = root;

        for (let i = 0; i < parts.length - 1; i++) {
          const folder = parts.slice(0, i+1).join('/');
          if (!folders[folder]) {
            const li = document.createElement("li");
            li.className = "folder";
            li.innerHTML = `<span>${parts[i]}/</span>`;
            const ul = document.createElement("ul");
            ul.style.display = "none";
            li.appendChild(ul);
            li.onclick = e => { e.stopPropagation(); ul.style.display = ul.style.display === "none" ? "block" : "none"; };

            folders[folder] = { li, ul };

            const parent = i === 0 ? root : folders[parts.slice(0,i).join('/')]?.ul;
            if (parent) parent.appendChild(li);
          }
          curUl = folders[folder].ul;
        }

        // Chỉ render file .html và không ẩn
        if (item.path.endsWith(".html") && !["CNAME","LICENSE","SECURITY.md","README.md"].includes(parts[parts.length-1]) && !item.path.startsWith(".")) {
          const li = document.createElement("li");
          li.className = "file";
          li.innerHTML = `<span>${parts[parts.length-1]}</span>`;
          li.onclick = () => { highlightActive(li); openNewPage(item.path); };
          curUl.appendChild(li);
        }
      });

      container.appendChild(root);
    }

    function highlightActive(li) {
      document.querySelectorAll('.tree li.active').forEach(el => el.classList.remove('active'));
      li.classList.add('active');
    }

    async function loadAllTitles(files) {
      const grid = document.getElementById("titles-grid");
      grid.innerHTML = '<div class="loading-titles"><i class="fas fa-spinner fa-spin"></i> Đang extract titles...</div>';

      const promises = files.map(async f => {
        try {
          const res = await fetch(`${rawBase}${f.path}`);
          if (!res.ok) return null;
          const html = await res.text();
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, "text/html");
          const title = doc.querySelector("title")?.textContent?.trim() || f.path.split('/').pop().replace(".html","");
          return { title, path: f.path };
        } catch {
          return null;
        }
      });

      const results = (await Promise.all(promises)).filter(Boolean);
      titlesData = results;

      if (results.length === 0) {
        grid.innerHTML = '<div class="error-titles">Không tìm thấy file HTML hợp lệ.</div>';
        return;
      }

      renderTitles(results);
    }

    function renderTitles(data) {
      const grid = document.getElementById("titles-grid");
      grid.innerHTML = data.map(({title, path}) => `
        <div class="title-card" onclick="openNewPage('${path}')">
          <div class="title-text">${title}</div>
          <div class="file-path">${path}</div>
        </div>
      `).join('');
    }

    function openNewPage(path) {
      const url = `${customDomain}${path}`;
      showLoader();
      const win = window.open(url, '_blank');
      if (!win || win.closed || typeof win.closed === 'undefined') {
        setTimeout(() => location.href = url, 2500);
      } else {
        setTimeout(hideLoader, 1500);
      }
    }

    // Search lọc cả tree + titles
    document.getElementById("search").addEventListener("input", e => {
      const term = e.target.value.toLowerCase().trim();

      // Lọc tree
      document.querySelectorAll(".tree li").forEach(li => {
        li.style.display = li.textContent.toLowerCase().includes(term) || !term ? "" : "none";
      });

      // Lọc titles grid
      if (titlesData.length) {
        const filtered = titlesData.filter(t => 
          t.title.toLowerCase().includes(term) || t.path.toLowerCase().includes(term)
        );
        renderTitles(filtered);
      }
    });

    window.addEventListener("load", hideLoader);
    loadRepo();
    setInterval(() => loadRepo(true), 120000); // silent update count & tree, không reload titles
  </script>
</body>
</html>
