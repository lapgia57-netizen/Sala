<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lapcoin (LOP) Swap - Responsive</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background: #f4f6f9; margin: 0; padding: 0; }
        .container { max-width: 500px; margin: 20px auto; background: white; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); padding: 20px; }
        h1 { text-align: center; color: #333; font-size: 24px; }
        .balance { text-align: center; font-size: 20px; margin: 20px 0; color: #2c3e50; }
        .price { text-align: center; font-size: 18px; color: #27ae60; margin-bottom: 20px; }
        .swap-box { background: #ecf0f1; border-radius: 10px; padding: 15px; }
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input { width: 100%; padding: 12px; font-size: 18px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .arrow { text-align: center; font-size: 30px; margin: 10px 0; color: #7f8c8d; }
        .output { background: #d5dbdb; pointer-events: none; }
        button { width: 100%; padding: 15px; font-size: 18px; background: #3498db; color: white; border: none; border-radius: 8px; cursor: pointer; margin-top: 10px; }
        button:hover { background: #2980b9; }
        button:disabled { background: #95a5a6; cursor: not-allowed; }
        #status { text-align: center; margin-top: 15px; font-weight: bold; color: #e74c3c; }
        @media (max-width: 480px) { .container { margin: 10px; padding: 15px; } h1 { font-size: 20px; } }
    </style>
</head>
<body>
    <div class="container">
        <h1>Lapcoin (LOP) Swap</h1>
        <div class="balance" id="lopBalance">Số dư LOP: Chưa kết nối ví</div>
        <div class="price">Mục tiêu: 1 LOP ≈ 0.00004 USD ≈ 1 VNĐ (tỷ giá ~25,000 VNĐ/USD)</div>
        <p style="text-align:center;font-size:14px;">Token: 0x9d475bd4f8d1b462ee4eda5aa6fa238bdd252103 (Polygon)</p>

        <div class="swap-box">
            <div class="input-group">
                <label>Từ (Bạn trả):</label>
                <input type="number" id="inputAmount" placeholder="0.0" min="0" step="any">
                <div style="text-align:right; margin-top:5px; color:#7f8c8d;">USDT (stablecoin ≈ USD)</div>
            </div>

            <div class="arrow">↓</div>

            <div class="input-group">
                <label>Đến (Bạn nhận LOP):</label>
                <input type="text" id="outputAmount" class="output" readonly placeholder="0.0">
            </div>

            <button id="connectBtn" onclick="connectWallet()">Kết nối Ví (MetaMask)</button>
            <button id="approveBtn" onclick="approveUSDT()" disabled>Approve USDT</button>
            <button id="swapBtn" onclick="swapUSDTtoLOP()" disabled>Mua LOP với USDT</button>
            <button id="swapSellBtn" onclick="swapLOPtoUSDT()" disabled>Bán LOP lấy USDT</button>
        </div>

        <div id="status"></div>
    </div>

    <script>
        const LOP_ADDRESS = "0x9d475bd4f8d1b462ee4eda5aa6fa238bdd252103";
        const USDT_ADDRESS = "0xc2132D05d31c914a87c6611c10748aeb04b58e8f"; // (PoS) USDT on Polygon
        const ROUTER_ADDRESS = "0xa5E0829CaCEd8fFDD4De3c43696c57F7D7A678ff"; // QuickSwap V2 Router

        const FIXED_PRICE_USD = 0.00004; // Giá mục tiêu

        let web3;
        let account;
        let lopContract;
        let usdtContract;
        let routerContract;

        const erc20ABI = [
            { "constant": true, "inputs": [{ "name": "_owner", "type": "address" }], "name": "balanceOf", "outputs": [{ "name": "balance", "type": "uint256" }], "type": "function" },
            { "constant": false, "inputs": [{ "name": "_spender", "type": "address" }, { "name": "_value", "type": "uint256" }], "name": "approve", "outputs": [{ "name": "", "type": "bool" }], "type": "function" },
            { "constant": true, "inputs": [], "name": "decimals", "outputs": [{ "name": "", "type": "uint8" }], "type": "function" }
        ];

        const routerABI = [
            { "inputs": [{ "internalType": "uint256", "name": "amountIn", "type": "uint256" }, { "internalType": "uint256", "name": "amountOutMin", "type": "uint256" }, { "internalType": "address[]", "name": "path", "type": "address[]" }, { "internalType": "address", "name": "to", "type": "address" }, { "internalType": "uint256", "name": "deadline", "type": "uint256" }], "name": "swapExactTokensForTokens", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
            { "inputs": [{ "internalType": "uint256", "name": "amountOut", "type": "uint256" }, { "internalType": "uint256", "name": "amountInMax", "type": "uint256" }, { "internalType": "address[]", "name": "path", "type": "address[]" }, { "internalType": "address", "name": "to", "type": "address" }, { "internalType": "uint256", "name": "deadline", "type": "uint256" }], "name": "swapTokensForExactTokens", "outputs": [], "stateMutability": "nonpayable", "type": "function" }
        ];

        async function connectWallet() {
            if (window.ethereum) {
                web3 = new Web3(window.ethereum);
                try {
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    const chainId = await web3.eth.getChainId();
                    if (chainId !== 137) {
                        alert("Vui lòng chuyển sang mạng Polygon Mainnet!");
                        return;
                    }
                    account = (await web3.eth.getAccounts())[0];
                    lopContract = new web3.eth.Contract(erc20ABI, LOP_ADDRESS);
                    usdtContract = new web3.eth.Contract(erc20ABI, USDT_ADDRESS);
                    routerContract = new web3.eth.Contract(routerABI, ROUTER_ADDRESS);

                    document.getElementById('connectBtn').innerText = `Đã kết nối: ${account.substr(0,6)}...${account.substr(-4)}`;
                    document.getElementById('connectBtn').disabled = true;
                    document.getElementById('approveBtn').disabled = false;
                    document.getElementById('swapBtn').disabled = false;
                    document.getElementById('swapSellBtn').disabled = false;

                    updateLOPBalance();
                    document.getElementById('status').innerText = "Đã kết nối ví thành công!";
                } catch (err) {
                    document.getElementById('status').innerText = "Kết nối bị từ chối.";
                }
            } else {
                alert("Vui lòng cài MetaMask!");
            }
        }

        async function updateLOPBalance() {
            if (!account) return;
            const balance = await lopContract.methods.balanceOf(account).call();
            const decimals = 18; // LOP có 18 decimals
            const formatted = web3.utils.fromWei(balance, 'ether');
            document.getElementById('lopBalance').innerText = `Số dư LOP: ${parseFloat(formatted).toLocaleString()} LOP`;
        }

        function calculateOutput() {
            const input = parseFloat(document.getElementById('inputAmount').value) || 0;
            const output = input / FIXED_PRICE_USD;
            document.getElementById('outputAmount').value = output.toFixed(2);
        }

        document.getElementById('inputAmount').addEventListener('input', calculateOutput);

        async function approveUSDT() {
            if (!account) return;
            const amount = document.getElementById('inputAmount').value;
            if (!amount || amount <= 0) { alert("Nhập số lượng USDT!"); return; }
            const decimals = 6; // USDT trên Polygon có 6 decimals
            const amountWei = web3.utils.toBN(amount * 10**decimals);
            document.getElementById('status').innerText = "Đang approve USDT...";
            try {
                await usdtContract.methods.approve(ROUTER_ADDRESS, amountWei).send({ from: account });
                document.getElementById('status').innerText = "Approve thành công!";
            } catch (err) {
                document.getElementById('status').innerText = "Approve thất bại: " + err.message;
            }
        }

        async function swapUSDTtoLOP() {
            if (!account) return;
            const amountIn = parseFloat(document.getElementById('inputAmount').value);
            if (!amountIn || amountIn <= 0) { alert("Nhập số lượng!"); return; }
            const amountInWei = web3.utils.toBN(amountIn * 10**6); // USDT 6 decimals
            const amountOutMin = 0; // Chấp nhận slippage cao vì demo (thực tế nên set 1-5%)
            const path = [USDT_ADDRESS, LOP_ADDRESS];
            const deadline = Math.floor(Date.now() / 1000) + 60 * 20; // 20 phút

            document.getElementById('status').innerText = "Đang swap... (xác nhận trong ví)";
            try {
                await routerContract.methods.swapExactTokensForTokens(
                    amountInWei, amountOutMin, path, account, deadline
                ).send({ from: account });
                document.getElementById('status').innerText = "Swap thành công!";
                updateLOPBalance();
            } catch (err) {
                document.getElementById('status').innerText = "Swap thất bại: " + (err.message.includes("INSUFFICIENT_OUTPUT_AMOUNT") ? "Không đủ thanh khoản hoặc slippage cao" : err.message);
            }
        }

        async function swapLOPtoUSDT() {
            if (!account) return;
            const amountOut = parseFloat(document.getElementById('outputAmount').value) || 0;
            if (amountOut <= 0) { alert("Tính toán số LOP trước!"); return; }
            const amountOutWei = web3.utils.toBN(amountOut * 10**18);
            const amountInMax = web3.utils.toBN(10**7); // Max slippage, thực tế tính đúng hơn
            const path = [LOP_ADDRESS, USDT_ADDRESS];
            const deadline = Math.floor(Date.now() / 1000) + 60 * 20;

            // Cần approve LOP trước cho router (thêm nút nếu cần)
            document.getElementById('status').innerText = "Đang bán LOP...";
            try {
                await routerContract.methods.swapTokensForExactTokens(
                    amountOutWei, amountInMax, path, account, deadline
                ).send({ from: account });
                document.getElementById('status').innerText = "Bán thành công!";
                updateLOPBalance();
            } catch (err) {
                document.getElementById('status').innerText = "Bán thất bại: " + err.message;
            }
        }
    </script>
</body>
</html>
